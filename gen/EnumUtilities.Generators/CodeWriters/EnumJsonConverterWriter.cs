// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 16.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace Raiqub.Generators.EnumUtilities.CodeWriters
{
    using Common;
    using Models;
    using System.Text;
    using T4CodeWriter;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "16.0.0.0")]
    public partial class EnumJsonConverterWriter : CodeWriterBase<EnumToGenerate>
    {
        /// <summary>
        /// Create the template output
        /// </summary>
        public override string TransformText()
        {

    if (Model.JsonConverterGeneratorOptions is null)
        return string.Empty;

            this.Write("// <auto-generated />\r\n#nullable enable\r\n\r\nusing System;\r\nusing System.Text.Json;\r\nusing System.Text.Json.Serialization;\r\nusing Raiqub.Generators.EnumUtilities.Formatters;\r\nusing Raiqub.Generators.EnumUtilities.Parsers;\r\n\r\n#pragma warning disable CS1591 // publicly visible type or member must be documented\r\n\r\n");

    if (!string.IsNullOrEmpty(Model.Namespace))
    {
        WriteLine($"namespace {Model.Namespace}");
        WriteLine("{");
        PushIndent();
    }

            this.Write("[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]\r\n[global::System.CodeDom.Compiler.GeneratedCodeAttribute(\"");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(CurrentAssemblyName.Name));
            
            #line default
            #line hidden
            this.Write("\", \"");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Append($"{CurrentAssemblyName.Version}")));
            
            #line default
            #line hidden
            this.Write("\")]\r\n");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.IsPublic ? "public" : "internal"));
            
            #line default
            #line hidden
            this.Write(" sealed class ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.Name));
            
            #line default
            #line hidden
            this.Write("JsonConverter : JsonConverter<");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.Name));
            
            #line default
            #line hidden
            this.Write(">\r\n{\r\n    private const int MaxBytesLength = ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.Values.Max(
                        x => GetEncodedLength(x.JsonPropertyName ?? x.SerializationValue ?? x.MemberName))));
            
            #line default
            #line hidden
            this.Write(";\r\n    private const int MaxCharsLength = ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.Values.Max(
                        x => x.JsonPropertyName?.Length ?? x.SerializationValue?.Length ?? x.MemberName.Length)));
            
            #line default
            #line hidden
            this.Write(";\r\n\r\n    public override ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.Name));
            
            #line default
            #line hidden
            this.Write(" Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)\r\n    {\r\n        if (reader.TokenType == JsonTokenType.String)\r\n            return (");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.RefName));
            
            #line default
            #line hidden
            this.Write(")ReadFromString(ref reader);\r\n");

    if (Model.JsonConverterGeneratorOptions.AllowIntegerValues)
    {

            this.Write("        if (reader.TokenType == JsonTokenType.Number)\r\n            return (");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.RefName));
            
            #line default
            #line hidden
            this.Write(")ReadFromNumber(ref reader);\r\n");

    }

            this.Write("\r\n        ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue(addReturn: true, castToEnum: true)));
            
            #line default
            #line hidden
            this.Write(";\r\n    }\r\n\r\n    public override void Write(Utf8JsonWriter writer, ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.RefName));
            
            #line default
            #line hidden
            this.Write(" value, JsonSerializerOptions options)\r\n    {\r\n        string? jsonString = value.ToJsonString();\r\n        if (jsonString is not null)\r\n        {\r\n            writer.WriteStringValue(jsonString);\r\n        }\r\n");

    if (Model.JsonConverterGeneratorOptions.AllowIntegerValues)
    {

            this.Write("        else\r\n        {\r\n            writer.WriteNumberValue((");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(")value);\r\n        }\r\n");

    }
    else if (Model.JsonConverterGeneratorOptions.DeserializationFailureFallbackValue is not null)
    {

            this.Write("        else\r\n        {\r\n            jsonString = ((");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.RefName));
            
            #line default
            #line hidden
            this.Write(")");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.JsonConverterGeneratorOptions.DeserializationFailureFallbackValue));
            
            #line default
            #line hidden
            this.Write(").ToJsonString();\r\n            if (jsonString is not null)\r\n                writer.WriteStringValue(jsonString);\r\n            else\r\n                throw new JsonException();\r\n        }\r\n");

    }
    else
    {

            this.Write("        else\r\n        {\r\n            throw new JsonException();\r\n        }\r\n");

    }

            this.Write("    }\r\n\r\n#if NET7_0_OR_GREATER\r\n\r\n    private ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" ReadFromString(ref Utf8JsonReader reader)\r\n    {\r\n        int length = reader.HasValueSequence ? checked((int)reader.ValueSequence.Length) : reader.ValueSpan.Length;\r\n        if (length > MaxBytesLength)\r\n            ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue(addReturn: true)));
            
            #line default
            #line hidden
            this.Write(";\r\n\r\n        Span<char> name = stackalloc char[MaxBytesLength];\r\n        int charsWritten = reader.CopyString(name);\r\n        name = name.Slice(0, charsWritten);\r\n\r\n        return name switch\r\n        {\r\n");

    foreach (var curr in Model.Values)
    {

            this.Write("            ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(curr.JsonPropertyName is not null || curr.SerializationValue is not null
                    ? Append($"\"{curr.JsonPropertyName ?? curr.SerializationValue}\"")
                    : Append($"\"{curr.MemberName}\"")));
            
            #line default
            #line hidden
            this.Write(" => ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(NeedNumberCasting() ? Append($"({Model.UnderlyingType})") : Append("")));
            
            #line default
            #line hidden
            
            this.Write(this.ToStringHelper.ToStringWithCulture(curr.MemberValue));
            
            #line default
            #line hidden
            this.Write(",\r\n");

    }

            this.Write("            //_ => EnumStringParser.TryParse(name, s_stringParser, StringComparison.OrdinalIgnoreCase, throwOnFailure: false, out ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" result) ? result : ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue()));
            
            #line default
            #line hidden
            this.Write("\r\n            _ => ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue()));
            
            #line default
            #line hidden
            this.Write("\r\n        };\r\n    }\r\n\r\n#else\r\n\r\n    private ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" ReadFromString(ref Utf8JsonReader reader)\r\n    {\r\n        var name = reader.GetString();\r\n        return name switch\r\n        {\r\n");

    foreach (var curr in Model.Values)
    {

            this.Write("            ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(curr.JsonPropertyName is not null || curr.SerializationValue is not null
                    ? Append($"\"{curr.JsonPropertyName ?? curr.SerializationValue}\"")
                    : Append($"\"{curr.MemberName}\"")));
            
            #line default
            #line hidden
            this.Write(" => ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(NeedNumberCasting() ? Append($"({Model.UnderlyingType})") : Append("")));
            
            #line default
            #line hidden
            
            this.Write(this.ToStringHelper.ToStringWithCulture(curr.MemberValue));
            
            #line default
            #line hidden
            this.Write(",\r\n");

    }

            this.Write("            //_ => EnumStringParser.TryParse(name, s_stringParser, StringComparison.OrdinalIgnoreCase, throwOnFailure: false, out ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" result) ? result : ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue()));
            
            #line default
            #line hidden
            this.Write("\r\n            _ => ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue()));
            
            #line default
            #line hidden
            this.Write("\r\n        };\r\n    }\r\n\r\n#endif\r\n");

    if (Model.JsonConverterGeneratorOptions.AllowIntegerValues)
    {

            this.Write("\r\n    private ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" ReadFromNumber(ref Utf8JsonReader reader)\r\n    {\r\n        return reader.TryGet");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(CSharpExtensions.GetTypeNameFromCSharpKeyword(Model.UnderlyingType)));
            
            #line default
            #line hidden
            this.Write("(out ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(Model.UnderlyingType));
            
            #line default
            #line hidden
            this.Write(" value)\r\n            ? value\r\n            : ");
            
            this.Write(this.ToStringHelper.ToStringWithCulture(AppendFallbackValue()));
            
            #line default
            #line hidden
            this.Write(";\r\n    }\r\n");

    }

            this.Write("}\r\n");

    if (!string.IsNullOrEmpty(Model.Namespace))
    {
        PopIndent();
        WriteLine("}");
    }

            return this.GenerationEnvironment.ToString();
        }

#nullable enable
    public EnumJsonConverterWriter(StringBuilder builder) : base(builder)
    {
    }

    public override string GetFileName() => $"{Model.Namespace ?? "_"}.{Model.Name}JsonConverter.g.cs";

    protected override bool CanGenerateFor(EnumToGenerate model) =>
        (model.SelectedGenerators & SelectedGenerators.JsonConverter) != 0;

    private None AppendFallbackValue(bool addReturn = false, bool castToEnum = false)
    {
        object? fallbackValue = Model.JsonConverterGeneratorOptions!.DeserializationFailureFallbackValue;
        if (fallbackValue is null)
            return Append("throw new JsonException()");

        if (addReturn)
            Append("return ");
        if (castToEnum)
            Append($"({Model.RefName})");
        if (!castToEnum && NeedNumberCasting())
            Append($"({Model.UnderlyingType})");

        return Append($"{fallbackValue}");
    }

    private static int GetEncodedLength(string value) => value.Sum(c => c < 128 ? 1 : 6);
    private bool NeedNumberCasting() => Model.UnderlyingType is "byte" or "short" or "sbyte" or "ushort";

    }
}
