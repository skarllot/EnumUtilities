using System.Reflection;
using System.Text;
using Raiqub.Generators.EnumUtilities.CodeWriters.EnumInfo;
using Raiqub.Generators.EnumUtilities.Common;
using Raiqub.Generators.EnumUtilities.Models;

namespace Raiqub.Generators.EnumUtilities.CodeWriters;

public class EnumInfoWriter : ICodeWriter<EnumToGenerate>
{
    private static AssemblyName CurrentAssemblyName { get; } = typeof(EnumInfoWriter).Assembly.GetName();

    public bool CanGenerateFor(EnumToGenerate model) =>
        (model.SelectedGenerators & SelectedGenerators.MainGenerator) != 0;

    public string GetFileName(EnumToGenerate model) => CodeWriterHelper.GetFileName(model, "EnumInfo");

    public void Write(StringBuilder builder, EnumToGenerate model)
    {
        builder.AppendUnixLine(
            """
            // <auto-generated />
            #nullable enable

            using System;
            using System.Runtime.CompilerServices;
            using Raiqub.Generators.EnumUtilities.Formatters;
            using Raiqub.Generators.EnumUtilities.Parsers;

            #pragma warning disable CS1591 // publicly visible type or member must be documented

            """
        );
        if (!string.IsNullOrEmpty(model.Namespace))
        {
            builder.AppendInterpolated($"namespace {model.Namespace};\n\n");
        }

        builder.AppendUnixLine(
            $$"""
            /// <summary>Provides metadata for <see cref="{{model.Name}}" /> enumeration.</summary>
            [global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]
            [global::System.CodeDom.Compiler.GeneratedCodeAttribute("{{CurrentAssemblyName.Name}}", "{{CurrentAssemblyName.Version}}")]
            {{(model.IsPublic ? "public" : "internal")}} static partial class {{model.MetadataClassName}}
            {
                /// <inheritdoc cref="Raiqub.Generators.EnumUtilities.Contracts.IEnumMetadata.MinimumValue" />
                public const {{model.UnderlyingType}} MinimumValue = {{model.OrderedValues.First().MemberValue}};

                /// <inheritdoc cref="Raiqub.Generators.EnumUtilities.Contracts.IEnumMetadata.MaximumValue" />
                public const {{model.UnderlyingType}} MaximumValue = {{model.OrderedValues.Last().MemberValue}};

                /// <inheritdoc cref="Raiqub.Generators.EnumUtilities.Contracts.IEnumMetadata.ValueCount" />
                public const int ValueCount = {{model.UniqueValues.Count}};

            """
        );

        EnumInfoDefaultBlock.Write(builder, model);

        builder.AppendUnixLine('}');
    }
}
